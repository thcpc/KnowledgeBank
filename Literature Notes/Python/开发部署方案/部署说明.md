# 1. 安装 Sentry
[[Install | 安装说明]]
# 2. 部署工程说明
## 2.1 工程目录
- eclinicalEt *根目录*
	- backend *后端工程文件夹*
		- et  *python代码文件夹*
		- DockerFile  *后端 Docker 的编译文件*
		- .env.production  *生产运行的配置文件*
		- alembic.ini *生产环境的数据库迁移配置文件*
	- frontend  *前端工程文件夹(引入前端这个工程排除node_module)*
		- .env.production  *生产配置文件*
		- DockerFile *前端 Docker的编译文件*
		- .... *其它文件就都是Node工程的正常文件*
	 - docker-compose.yml *Docker Compose 的配置文件*

## 2.2 docker-compose.yml
*为了避免权限问题,所以文件映射指向了Home下面的用户路径*
```yml

volumes:
  et_backend_static_volume:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: /home/ec2-user/et_storge/et_backend_static  # (绝对路径)
  et_backend_media_volume:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: /home/ec2-user/et_storge/et_backend_media  # (绝对路径)
  et_backend_data_volume:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: /home/ec2-user/et_storge/et_backend_data  # (绝对路径)
  et_backend_log_volume:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: /home/ec2-user/et_storge/et_backend_log  # (绝对路径)
  et_frontend_static_volume:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: /home/ec2-user/et_storge/et_frontend_static  # (绝对路径)
  et_frontend_media_volume:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: /home/ec2-user/et_storge/et_frontend_media  # (绝对路径)

services:
  etbackend:
    build: ./backend
    env_file: backend/.env.production
    volumes:
      - et_backend_static_volume:/app/static
      - et_backend_media_volume:/app/media
      - et_backend_data_volume:/app/data
      - et_backend_log_volume:/var/log/django
    expose:
      - "8000"
    extra_hosts:
      - "automation-01.chengdudev.edetekapps.cn:172.17.0.1" 

  etfrontend:
    build: ./frontend
    ports:
       - "80:80"
    depends_on:
      - etbackend
    volumes:
      - ./frontend:/app
```
## 2.3 Backend
### DockerFile
```dockerfile
# 第一阶段：构建
FROM python:3.13-slim as builder

WORKDIR /app

RUN mkdir -p /root/.local && apt-get update && apt-get install -y \
    gcc \
    python3-dev \
    libuv1-dev pkg-config libmariadb3 libmariadb-dev libmariadb-dev-compat
COPY et/. .
COPY alembic.ini .

RUN pip install --user -r requirements.txt
RUN pip install --user uvloop 

# 第二阶段：运行
FROM python:3.13-slim

WORKDIR /app
RUN apt-get update && apt-get install -y \
    libmariadb3 \         
    libuv1
                 
COPY --from=builder /root/.local /root/.local
COPY --from=builder /app/. .


ENV PATH=/root/.local/bin:$PATH
ENV PYTHONUNBUFFERED=1

EXPOSE 8000

# CMD ["tail", "-f", "/dev/null"] # 调试命令
CMD ["sh", "-c","alembic upgrade head && uvicorn et.asgi:application --host 0.0.0.0 --port 8000 --lifespan off"]
```
### .env.production
```properties
# 基础配置
DEBUG=False
SECRET_KEY=django-insecure-3ia4l-%ej+vp$-a3&p#l5cfinj^8g_u1g)icpjat1z(pct6qq5
ALLOWED_HOSTS=localhost,127.0.0.1,etbackend,automation-01.chengdudev.edetekapps.cn
CORS_ALLOWED_ORIGINS=http://localhost:5173,http://127.0.0.1:5173,http://127.0.0.1:8080,http://etbackend:8000,http://automation-01.chengdudev.edetekapps.cn
CORS_ORIGIN_WHITELIST=http://localhost:5173,http://127.0.0.1:5173,http://automation-01.chengdudev.edetekapps.cn
CORS_ALLOW_HEADERS=content-type,x-csrftoken,authorization,X-CSRFToken
CORS_ALLOWED_METHODS=DELETE,GET,OPTIONS,PATCH,POST,PUT,VIEW
CSRF_TRUSTED_ORIGINS=http://localhost:5173,http://127.0.0.1:5173,http://automation-01.chengdudev.edetekapps.cn


# 数据库 (支持多种格式)
DATABASE_URL=mysql://root:123456@automation-01.chengdudev.edetekapps.cn:3306/et_dev
DATABASE_NAME=et_dev
DATABASE_USER=root
DATABASE_PASSWORD=123456
DATABASE_HOST=automation-01.chengdudev.edetekapps.cn
DATABASE_PORT=3306


# 缓存
# CACHE_URL=rediscache://automation-01.chengdudev.edetekapps.cn:9999/3?client_class=django_redis.client.DefaultClient
REDIS_HOST=automation-01.chengdudev.edetekapps.cn
REDIS_PORT=9999
REDIS_DB=3
REDIS_MAX_CONNECTIONS=10


# 邮件
EMAIL_URL=smtp://user:password@gmail.com:587/?tls=True

# 第三方服务
CELERY_BROKER_URL=redis://automation-01.chengdudev.edetekapps.cn:9999/0
CELERY_RESULT_BACKEND='redis://automation-01.chengdudev.edetekapps.cn:9999/1'
CELERY_ACCEPT_CONTENT='json'
CELERY_TASK_SERIALIZER='json'
CELERY_RESULT_SERIALIZER='json'
# SENTRY
SENTRY_DSN=http://9e7448173924abce3d39403b15a469a8@automation-01.chengdudev.edetekapps.cn:9000/2

```

## 2.4 Frontend 
### DockerFile
```dockerfile
# 第一阶段：构建
FROM node:lts as build-stage

WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build
# 第二阶段：构建的内容打入nginx
FROM nginx:stable-alpine
COPY --from=build-stage /app/dist /usr/share/nginx/html
COPY ./nginx.conf /etc/nginx/conf.d/default.conf


EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```
### nginx.conf
```nginx
upstream backend {
    server etbackend:8000;
}


server {
    listen 80;
    listen [::]:80;
    server_name automation-01.chengdudev.edetekapps.cn;

    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Cookie $http_cookie;
    proxy_set_header X-Forwarded-Server $host;

    # 后端API
    location /user/api/ {
        proxy_pass http://backend;
        proxy_connect_timeout 110s;
        proxy_read_timeout 160s;
        add_header 'Access-Control-Allow-Origin' *;
        add_header 'Access-Control-Allow-Headers' "Origin, X-Requested-With, Content-Type, Accept";
        add_header 'Access-Control-Allow-Methods' "GET, POST, OPTIONS";
        add_header 'Access-Control-Allow-Credentials' 'true';
    }

    # 后端API
    location /document/api/ {
        proxy_pass http://backend;
        proxy_connect_timeout 110s;
        proxy_read_timeout 160s;
        add_header 'Access-Control-Allow-Origin' *;
        add_header 'Access-Control-Allow-Headers' "Origin, X-Requested-With, Content-Type, Accept";
        add_header 'Access-Control-Allow-Methods' "GET, POST, OPTIONS";
        add_header 'Access-Control-Allow-Credentials' 'true';
    }

    # 后端API
    location /admin/api/ {
        proxy_pass http://backend;
        proxy_connect_timeout 110s;
        proxy_read_timeout 160s;
        add_header 'Access-Control-Allow-Origin' *;
        add_header 'Access-Control-Allow-Headers' "Origin, X-Requested-With, Content-Type, Accept";
        add_header 'Access-Control-Allow-Methods' "GET, POST, OPTIONS";
        add_header 'Access-Control-Allow-Credentials' 'true';
    }

    # 后端API
    location /label/api/ {
        proxy_pass http://backend;
        proxy_connect_timeout 110s;
        proxy_read_timeout 160s;
        add_header 'Access-Control-Allow-Origin' *;
        add_header 'Access-Control-Allow-Headers' "Origin, X-Requested-With, Content-Type, Accept";
        add_header 'Access-Control-Allow-Methods' "GET, POST, OPTIONS";
        add_header 'Access-Control-Allow-Credentials' 'true';
    }

    # 后端API
    location /task/api/ {
        proxy_pass http://backend;
        proxy_connect_timeout 110s;
        proxy_read_timeout 160s;
        add_header 'Access-Control-Allow-Origin' *;
        add_header 'Access-Control-Allow-Headers' "Origin, X-Requested-With, Content-Type, Accept";
        add_header 'Access-Control-Allow-Methods' "GET, POST, OPTIONS";
        add_header 'Access-Control-Allow-Credentials' 'true';
    }

   
    # 后端静态文件
    location /static/ {
        alias /app/static/;
    }

    # 媒体文件
    location /media/ {
        alias /app/media/;
    }

    # 前端路由
    location / {
        root /usr/share/nginx/html;
        try_files $uri $uri/ /index.html;
    }
}
```

### .env.production
```properties
VITE_API_BASE_URL=http://automation-01.chengdudev.edetekapps.cn
```


# 3. 数据库迁移控制方案
采用 alembic 来控制数据迁移，主要是因为数据库框架主要用的是 SQLAlchemy
## 3.1 工程配置
在 [[部署说明#2.1 工程目录 | 工程目录]] 中创建 alembic.ini 配置生产环境的数据库地址
在  开发环境 中创建 alembic.ini 配置开发环境的数据库地址
## 3.2 开发指南
### 3.2.1 工程初始化
建立 alembic 文件夹， 并配置 模型

### 3.2.2 当数据库模型有修改时或需要迁移数据时
- S1. 执行如下命令
```shell
# 添加你的描述
alembic revision --autogenerate -m "XXXXXXXX"
```
这时会在 alembic/version 生成如下图的py文件
![[Pasted image 20250724164201.png]]
- S2. 需要处理数据
 在S1的基础上，生成文件后，在文件中添加处理数据的代码
 ![[Pasted image 20250724172025.png]]
 - upgrade
 升级时的处理数据代码
 - downgrade
 降级时的处理数据代码